{% extends '::layout.html.twig' %}
{% block id 'mod_reimprimir_ticket' %}

{% block title %}
    {{ parent() }} - Apertura {{ 'views.show.show'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}
{% endblock %}

{% block page %}

    <section id="view_Apertura">
        <header>
            <h1>Reimpresión de Ticket - Comprobante Número {{ entity.id }}</h1>
        </header>
        {{ wo_render_breadcrumbs() }}
        {% for type, flashMessages in app.session.flashbag.all() %}
            {% for flashMessage in flashMessages %}
                <div class='alert alert-{{ type }}'>
                    {{ flashMessage|trans({}, 'JordiLlonchCrudGeneratorBundle') }}
                </div>
            {% endfor %}
        {% endfor %}
        <div class="row-fluid">
            <div class="span12">
                <form class="form-horizontal">
                    <fieldset>
                        <div class="control-group">
                            <label class="control-label">Fecha</label>

                            <div class="controls"><span
                                    class="input-xlarge uneditable-input">{{ entity.fecha|date('d-m-Y ') }}</span>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Código de Barra</label>

                            <div class="controls"><span
                                    class="input-xlarge uneditable-input">{{ entity.codigoBarra }}</span></div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Comprobante</label>

                            <div class="controls"><span
                                    class="input-xlarge uneditable-input">{{ entity.comprobante }}</span></div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Sección</label>

                            <div class="controls"><span
                                    class="input-xlarge uneditable-input">{{ seccion }}</span></div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Referencia</label>

                            <div class="controls"><span
                                    class="input-xlarge uneditable-input">{{ referencia }}</span></div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Importe</label>

                            <div class="controls"><span
                                    class="input-xlarge uneditable-input">
                                        {{ entity.importe | number_format(2, '.', ',')  }}
                                        </span>

                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>


        <div class="row-fluid">
            <div class="span12">
                <form id="form_reimpresion_ticket" class="form-horizontal" action="{{ path('apertura_reimprimir_ticket', { 'id': entity.id }) }}">
                    <div class="offset2 span2">
                        <a class="btn" href="{{ path('apertura') }}">
                            {{ 'views.recordactions.backtothelist'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}
                        </a>
                    </div>
                    <div class="span2">
                        <button type="submit" class="btn btn-success">{{ 'Reimprimir'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}</button>
                    </div>
                </form>
            </div>
        </div>

        {% block javascriptshead %}
        <script src="{{  asset('js/jquery.form.min.js') }}"></script>
        <script src="{{  asset('js/deployJava.js') }}"></script>
    {% endblock %}

    <script>

        var attributes = {
            code:       "applet.Main",
            archive:    "{{  asset('SerialLar.jar')}}",
            width:      5,
            height:     5,
            id:			'SerialLar',
            visible: false
        };
        var parameters = {separate_jvm:"true", draggable:"true", jnlp_href:"{{  asset('SerialLar.jnlp') }}", puerto: "{{ caja.puerto }}"}; <!-- Applet Parameters -->
        var version = "1.5"; <!-- Required Java Version -->
        deployJava.runApplet(attributes, parameters, version);
    </script>

    <script>
        $(function() {
            $("#form_reimpresion_ticket").submit(function(e){
                e.preventDefault();
                $.blockUI({ message: "Reimprimiendo ticket..." });
                $("#form_reimpresion_ticket").ajaxSubmit({
                    dataType: 'json',
                    success: function(data, statusText, xhr, $form){

                        if(statusText == 'success'){
                            if(data.ok == 1){
                                imprimirSerial(data.tk);
                                //Despues de imprimir, mando el mail como una llamada ajax separada:
                                $.unblockUI();
                                window.location = "{{ path('apertura') }}";
                            }
                            else if(data.ok != 1){
                                $.unblockUI();
                                alert('Mensaje de error: ' + data.msg);
                            }
                        }
                    },
                    error: function(data){
                        $.unblockUI();
                        alert('Mensaje de error al reimprimir: ' + data.msg + '. Ticket: ' + data.tk);

                    }
                });

                return false;
            });
        });

        /**
         * Manda a la impresora fiscal.
         * @param data
         */
        imprimirSerial = function(data){
            var pser = document.SerialLar;
            try {
                //Particiono la variable tk recibida, para evitar el llenado del buffer:
                for (var i=0;i<data.length; i+=500) {
                    var t = new Date().getTime();
                    while ((new Date().getTime()) -t < 1000) {
                        //alert('timer');
                    }

                    pser.escribir(data.substr(i, 500));
                }
                $.unblockUI();
            } catch (e) {
                $.unblockUI();
                alert('Error de tipo: ' + e);
            }
        }
    </script>
{% endblock %}