{% extends '::layout.html.twig' %}
{% block id 'mod_apertura' %}

    {% block title %}
        {{ parent() }} - Apertura {{ 'views.new.creation'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}
    {% endblock %}

    {% block page %}

        <section id="new_Apertura">
            <header>
                <h1>Apertura {{ 'views.new.creation'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}</h1>
            </header>
            {{ wo_render_breadcrumbs() }}
            {% for type, flashMessages in app.session.flashbag.all() %}
                {% for flashMessage in flashMessages %}
                    <div class='alert alert-{{ type }}'>
                        {{ flashMessage|trans({}, 'JordiLlonchCrudGeneratorBundle') }}
                    </div>
                {% endfor %}
            {% endfor %}

            <div class="row-fluid">
                <div class="span12">

                    <form id="form_apertura" class="form-horizontal" action="{{ path('apertura_create') }}"
                          method="post" {{ form_enctype(form) }}>
                        {{ form_widget(form) }}
                        <div class="form-actions">
                            <button type="submit"
                                    class="btn btn-success">{{ 'views.new.create'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="row-fluid">
                <div class="span12">
                    <div class="offset2 span2">
                        <a class="btn" href="{{ path('apertura') }}">
                            {{ 'views.recordactions.backtothelist'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}
                        </a>
                    </div>
                </div>
            </div>
        </section>
        <script src="{{  asset('js/deployJava.js') }}"></script>
        <script>
            var tipoPagoDefault = {{ tipoPagoDefault }};

            console.log("tipo Pago " + tipoPagoDefault);

            var attributes = {
                code:       "applet.Main",
                archive:    "{{  asset('SerialLar.jar')}}",
                width:      5,
                height:     5,
                id:			'SerialLar',
                visible: false
            };
            var parameters = {separate_jvm:"true", draggable:"true", jnlp_href:"{{  asset('SerialLar.jnlp') }}", puerto: "{{ caja.puerto }}"}; <!-- Applet Parameters -->
            var version = "1.5"; <!-- Required Java Version -->
            deployJava.runApplet(attributes, parameters, version);
        </script>

        <script>
            $(function() {
                $("#form_apertura").submit(function(e){
                    $(this).ajaxSubmit({
                        dataType: 'json',
                        success: function(data, statusText, xhr, $form){
                            if(statusText == 'success'){
                                if(data.ok == 1){
                                    imprimirSerial(data.tk);
                                    //redirigir
                                    window.location = "{{ path('registro') }}";
                                }
                                else if(data.ok != 1){
                                    alert(data.msg);
                                }
                            }
                        }});

                    e.isDefaultPrevented();
                });

            });

            /**
             * Manda a la impresora fiscal.
             * @param data
             */
            imprimirSerial = function(data){
                var pser = document.SerialLar;
                try {
                    pser.escribir(data);
                } catch (e) {
                    alert(e);
                }
            }

        </script>
    {% endblock %}