<?php

namespace Caja\SistemaCajaBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * AperturaRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class AperturaRepository extends EntityRepository
{
    public function getAperturas($usuario){
        $em = $this->getEntityManager();

        $a = $this->createQueryBuilder("a")
            ->join("a.caja","c")
            ->where('c.cajero = :cajero')
            ->setParameter("cajero", $usuario->getId())
            ->orderBy("a.fecha",'asc');

        return $a;
    }

    public function getPagosByTipoPago($apertura_id)
    {
        $em = $this->getEntityManager();

        $q = $em->createQuery("
              SELECT
                  t.id,t.descripcion,p.anulado,sum(p.importe)
              FROM
                  SistemaCajaBundle:LotePago p JOIN p.tipo_pago t JOIN p.lote l
              WHERE
                  l.apertura = :apertura_id
              GROUP BY
                  t.descripcion, p.anulado
              ORDER BY
                  t.id ")
            ->setParameter("apertura_id", $apertura_id)
        ;

        $res = $q->getResult();

        return $res;

    }

}
